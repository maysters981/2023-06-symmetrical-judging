volodya

high

# Solvency is not being checked correctly on opening position

## Summary
I think open position might be liquidated right after opening due to incorrect solvency check
## Vulnerability Detail
This is how solvency is being checked in the code. Let's assume `quote.quantity == filledAmount` and `quote.orderType == OrderType.LIMIT` on opening a position, then amount calculate by `isSolventAfterOpenPosition` added to locked balance will be
```solidity
        lockedAmount =
            (filledAmount * (quote.lockedValues.cva + quote.lockedValues.lf)) /
            quote.quantity;

        partyAAvailableBalance -= int256(lockedAmount);

```
`quote.lockedValues.cva + quote.lockedValues.lf + quote.lockedValues.mm`
While the actual quote that is being added to the locked balance will be
`(quote.lockedValues.cva + quote.lockedValues.lf + quote.lockedValues.mm) * openedPrice / quote.requestedOpenPrice`
due to this code
```solidity
           if (quote.orderType == OrderType.LIMIT) {
                quote.lockedValues.mul(openedPrice).div(quote.requestedOpenPrice);
            }
            accountLayout.lockedBalances[quote.partyA].addQuote(quote);
 
```
[facets/PartyB/PartyBFacetImpl.sol#L164](https://github.com/sherlock-audit/2023-06-symmetrical/blob/main/symmio-core/contracts/facets/PartyB/PartyBFacetImpl.sol#L164)

So whenever `openedPrice > quote.requestedOpenPrice` there is a possibility that the position will be liquidated while the solvency check will be passed 


## Impact
Positions might be liquidated right after the creation.
## Code Snippet

## Tool used

Manual Review

## Recommendation
I think it will be better to implement the same liquidation check like this at the end of opening position
