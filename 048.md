volodya

high

# Solvency is not being checked correctly on opening position

## Summary
I think an open position might be liquidated right after opening due to an incorrect solvency check
## Vulnerability Detail
Whevener partyA opens a position there is a call to `openPosition`. There is a check for solvency `LibSolvency.isSolventAfterOpenPosition(quoteId, filledAmount, upnlSig)`
lockedValues there is not being normalized by openedPrice and quote.requestedOpenPrice like it's happening right after solvency when actually adding to locking balances.

```solidity
        if (quote.orderType == OrderType.LIMIT) {
            lockedAmount =
                (filledAmount * (quote.lockedValues.cva + quote.lockedValues.lf)) /
                quote.quantity;
            lockedMM = (filledAmount * quote.lockedValues.mm) / quote.quantity;
        } else {
            lockedAmount = quote.lockedValues.cva + quote.lockedValues.lf;
            lockedMM = quote.lockedValues.mm;
        }

        partyAAvailableBalance -= int256(lockedAmount);
        partyBAvailableBalance -= int256(lockedAmount);
```
[/symmio-core/contracts/libraries/LibSolvency.sol#L33](https://github.com/sherlock-audit/2023-06-symmetrical/blob/main/symmio-core/contracts/libraries/LibSolvency.sol#L33)

```solidity
            if (quote.orderType == OrderType.LIMIT) {
                quote.lockedValues.mul(openedPrice).div(quote.requestedOpenPrice);
            }
            accountLayout.lockedBalances[quote.partyA].addQuote(quote);
            accountLayout.partyBLockedBalances[quote.partyB][quote.partyA].addQuote(quote);
        }
        // partially fill
        else {
...
            LockedValues memory filledLockedValues = LockedValues(
                (quote.lockedValues.cva * filledAmount) / quote.quantity,
                (quote.lockedValues.mm * filledAmount) / quote.quantity,
                (quote.lockedValues.lf * filledAmount) / quote.quantity
            );
            LockedValues memory appliedFilledLockedValues = filledLockedValues;
            appliedFilledLockedValues = appliedFilledLockedValues.mulMem(openedPrice);
            appliedFilledLockedValues = appliedFilledLockedValues.divMem(quote.requestedOpenPrice);
...
            quote.lockedValues = appliedFilledLockedValues;
...
            accountLayout.lockedBalances[quote.partyA].addQuote(quote);
  
```
[facets/PartyB/PartyBFacetImpl.sol#L159](https://github.com/sherlock-audit/2023-06-symmetrical/blob/main/symmio-core/contracts/facets/PartyB/PartyBFacetImpl.sol#L159)
## Impact
A position might be liquidated after creation or a position will not be opened when it should
## Code Snippet

## Tool used

Manual Review

## Recommendation
Normlie values like its done after solvency check inside openPosition function

```diff
        if (quote.orderType == OrderType.LIMIT) {
            lockedAmount =
                (filledAmount * (quote.lockedValues.cva + quote.lockedValues.lf)) /
                quote.quantity;
            lockedMM = (filledAmount * quote.lockedValues.mm) / quote.quantity;
        } else {
            lockedAmount = quote.lockedValues.cva + quote.lockedValues.lf;
            lockedMM = quote.lockedValues.mm;
        }
+        lockedAmount =lockedAmount *openedPrice / requestedOpenPrice;
+        lockedMM =lockedMM *openedPrice / requestedOpenPrice;
        partyAAvailableBalance -= int256(lockedAmount);
        partyBAvailableBalance -= int256(lockedAmount);

```